# Build against RACK 0.6.2 

trigger:
- master

pr:
- master

jobs:
- job: Build
  strategy:
    matrix:
      mac10:
        imageName: 'macos-10.13'
        isMac: true
        sdkURL: https://vcvrack.com/downloads/Rack-SDK-1.dev.ddf06a9.zip
        artifactMatrixID: 'SURGERACK_ZIP_MACOS_10' 
      windows10:
        imageName: 'vs2017-win2016'
        isWindows: true
        sdkURL: https://vcvrack.com/downloads/Rack-SDK-1.dev.ddf06a9.zip
        artifactMatrixID: 'SURGERACK_ZIP_WINDOWS_10'  
      linux10:
        imageName: 'ubuntu-16.04'
        isLinux: true
        sdkURL: https://vcvrack.com/downloads/Rack-SDK-1.dev.ddf06a9.zip
        artifactMatrixID: 'SURGERACK_ZIP_LINUX_10'  

  pool:
    vmImage: $(imageName)

  steps:
  - checkout: self
    fetchDepth: 1
    # submodules: recursive # can't do submodules here b'cuz depth=1 fails with Github

  - bash: |
      pushd $AGENT_TEMPDIRECTORY
      curl -o Rack-SDK.zip  $(sdkURL)
      unzip Rack-SDK.zip
      ls -alFh
      ls -alFh Rack-SDK
      popd
    displayName: Get Rack  


  - bash: |
      git submodule update --init --recursive
    displayName: Get Surge SubModule

  - bash: |
      which g++
      g++ --version
    displayName: Dump Windows Versions
    condition: variables.isWindows

  - bash: |
      export RACK_DIR=$AGENT_TEMPDIRECTORY/Rack-SDK
      export CC=gcc
      export CPP=g++
      echo RACK_DIR is ${RACK_DIR}
      ls ${RACK_DIR}/include
      make -j 4 win-dist

      mkdir products/
      cp dist/*zip products/
    displayName: Build Windows Plugins
    condition: variables.isWindows

  - bash: |
      export RACK_DIR=$AGENT_TEMPDIRECTORY/Rack-SDK
      make -j 4 dist
      mkdir products/
      cp dist/*zip products/
    displayName: Build Mac Plugins
    condition: variables.isMac

  - bash: |
      export RACK_DIR=$AGENT_TEMPDIRECTORY/Rack-SDK
      make -j 4 dist
      mkdir products/
      cp dist/*zip products/
    displayName: Build Linux Plugins
    condition: variables.isLinux

  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: $(artifactMatrixID)
      targetPath: 'products/'
    displayName: Publish Zip


- job: UpdateGithubRelease
  dependsOn: Build
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))

  steps:

  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: 'SURGERACK_ZIP_LINUX_10'
      targetPath: $(Build.ArtifactStagingDirectory)

  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: 'SURGERACK_ZIP_MACOS_10'
      targetPath: $(Build.ArtifactStagingDirectory)

  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: 'SURGERACK_ZIP_WINDOWS_10'
      targetPath: $(Build.ArtifactStagingDirectory)

  - bash: |
     echo "## Automatically Generated SurgeRack Release" > $(Build.ArtifactStagingDirectory)/ReleaseNotes.md
     echo >> $(Build.ArtifactStagingDirectory)/ReleaseNotes.md
     date >> $(Build.ArtifactStagingDirectory)/ReleaseNotes.md
     echo >> $(Build.ArtifactStagingDirectory)/ReleaseNotes.md
     echo "Most recent commits:" >> $(Build.ArtifactStagingDirectory)/ReleaseNotes.md
     git log --pretty=oneline | head -5 >> $(Build.ArtifactStagingDirectory)/ReleaseNotes.md
    displayName: Fake up release notes


  - bash: |
     ls -l $(Build.ArtifactStagingDirectory)
     export EXTEND_TAG=`date "+%Y%m%d-%H%M"`-`git rev-parse --short HEAD`
     for file in $(Build.ArtifactStagingDirectory)/*.zip; do mv "$file" "${file/.zip/-${EXTEND_TAG}.zip}"; done
     ls -l $(Build.ArtifactStagingDirectory)         
    displayName: Tag asset names with Date


  - task: GitHubRelease@0
    displayName: "Update Github Release"
    inputs:
      gitHubConnection: surge-rackupdater
      repositoryName: surge-synthesizer/surge-rack
      action: edit
      tag: Nightly
      addChangeLog: false
      releaseNotesFile: $(Build.ArtifactStagingDirectory)/ReleaseNotes.md
      assets: $(Build.ArtifactStagingDirectory)/*.zip

